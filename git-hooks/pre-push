#!/usr/bin/env python3
"""
git pre-push hook: block push if 'make all' fails.

Runs 'make all' from the repository root before allowing a push.
If the command exits non-zero, the push is blocked.
"""
from __future__ import annotations

import os
import subprocess
import sys


def repo_root() -> str:
    try:
        out = subprocess.run(
            ["git", "rev-parse", "--show-toplevel"],
            check=True,
            capture_output=True,
            text=True,
        )
        return out.stdout.strip() or os.getcwd()
    except Exception:
        return os.getcwd()


def main() -> int:
    root = repo_root()
    print(f"[pre-push] Running 'make all' in {root} ...", flush=True)
    try:
        rc = subprocess.run(["make", "all"], cwd=root).returncode
    except FileNotFoundError:
        sys.stderr.write("[pre-push] error: 'make' not found in PATH\n")
        return 1
    except Exception as e:  # pragma: no cover
        sys.stderr.write(f"[pre-push] error: failed to run 'make all': {e}\n")
        return 1

    if rc != 0:
        sys.stderr.write("[pre-push] ❌ 'make all' failed; blocking push.\n")
        return rc if rc != 0 else 1

    print("[pre-push] ✅ 'make all' passed; allowing push.")
    return 0


if __name__ == "__main__":
    sys.exit(main())
