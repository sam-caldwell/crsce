#!/usr/bin/env python3
"""
Git pre-commit hook (Python 3):

Performs fast, local quality gates before allowing a commit:
- Checks staged changes for whitespace errors via git diff-index --check
- Runs project linters (make lint)
- Enforces a test coverage threshold (make cover)

Exits non-zero to block the commit on any failure.
"""

from __future__ import annotations

import shutil
import subprocess
import sys
from typing import List


def _run_capture(cmd: List[str]) -> subprocess.CompletedProcess:
    """Run a command, capturing stdout/stderr (text)."""
    return subprocess.run(
        cmd,
        check=False,
        text=True,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
    )


def _run_stream(cmd: List[str]) -> int:
    """Run a command, streaming output to the terminal; return exit code."""
    try:
        cp = subprocess.run(cmd, check=False)
        return cp.returncode
    except FileNotFoundError:
        return 127


def _git_against_ref() -> str:
    """Return 'HEAD' or the empty tree hash on the initial commit."""
    rc = subprocess.run(
        ["git", "rev-parse", "--verify", "HEAD"],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        check=False,
    ).returncode
    if rc == 0:
        return "HEAD"
    # Initial commit: diff against an empty tree object
    empty_tree = subprocess.check_output(
        ["git", "hash-object", "-t", "tree", "/dev/null"], text=True
    ).strip()
    return empty_tree


def whitespace_check() -> int:
    """Check staged diffs for whitespace errors; print diagnostics on failure."""
    against = _git_against_ref()
    res = _run_capture(["git", "diff-index", "--check", "--cached", against, "--"])
    if res.returncode != 0:
        # Match legacy behavior: direct messages to stderr
        if res.stdout:
            sys.stderr.write(res.stdout)
        if res.stderr:
            sys.stderr.write(res.stderr)
        sys.stderr.write(
            "Aborting commit due to whitespace errors in staged changes.\n"
        )
    return res.returncode


def ensure_make() -> None:
    if not shutil.which("make"):
        sys.stderr.write(
            "pre-commit: 'make' not found. Install build tools or run 'make ready/fix'.\n"
        )
        sys.exit(127)


def main() -> int:
    # 1) Whitespace check on staged changes
    if whitespace_check() != 0:
        print("git commit failed because whitespace is detected in files.  run 'make whitespace/fix' and try again.")
        return 1

    ensure_make()

    # 2) Run linters (fast fail)
    lint_rc = _run_stream(["make", "lint"])
    if lint_rc != 0:
        print("git commit failed because linter failed")
        return lint_rc

    return 0


if __name__ == "__main__":
    sys.exit(main())
